services:
  ansible-master:
    build:
      context: .
      dockerfile: Dockerfile.master
    container_name: ansible-master
    volumes:
      - ./playbooks:/playbooks
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - ansible-net

  node-1:
    build:
      context: .
      dockerfile: Dockerfile.node
    container_name: node-1
    profiles:
      - rocky
    networks:
      - ansible-net

  node-2:
    build:
      context: .
      dockerfile: Dockerfile.node
    container_name: node-2
    profiles:
      - rocky
    networks:
      - ansible-net

  node-3:
    build:
      context: .
      dockerfile: Dockerfile.node
    container_name: node-3
    profiles:
      - rocky
    networks:
      - ansible-net

  node-4:
    build:
      context: .
      dockerfile: Dockerfile.node
    container_name: node-4
    profiles:
      - rocky
    networks:
      - ansible-net

  zookeeper-1:
    image: zookeeper:3.9
    container_name: zookeeper-1
    profiles:
      - zookeeper
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zookeeper-1:2888:3888;2181 server.2=zookeeper-2:2888:3888;2181 server.3=zookeeper-3:2888:3888;2181 server.4=zookeeper-4:2888:3888:observer;2181
      ZOO_4LW_COMMANDS_WHITELIST: "*"
    networks:
      - ansible-net
      - zk-net

  zookeeper-2:
    image: zookeeper:3.9
    container_name: zookeeper-2
    profiles:
      - zookeeper
    environment:
      ZOO_MY_ID: 2
      ZOO_SERVERS: server.1=zookeeper-1:2888:3888;2181 server.2=zookeeper-2:2888:3888;2181 server.3=zookeeper-3:2888:3888;2181 server.4=zookeeper-4:2888:3888:observer;2181
      ZOO_4LW_COMMANDS_WHITELIST: "*"
    networks:
      - ansible-net
      - zk-net

  zookeeper-3:
    image: zookeeper:3.9
    container_name: zookeeper-3
    profiles:
      - zookeeper
    environment:
      ZOO_MY_ID: 3
      ZOO_SERVERS: server.1=zookeeper-1:2888:3888;2181 server.2=zookeeper-2:2888:3888;2181 server.3=zookeeper-3:2888:3888;2181 server.4=zookeeper-4:2888:3888:observer;2181
      ZOO_4LW_COMMANDS_WHITELIST: "*"
    networks:
      - ansible-net
      - zk-net

  zookeeper-4:
    image: zookeeper:3.9
    container_name: zookeeper-4
    profiles:
      - zookeeper
    environment:
      ZOO_MY_ID: 4
      ZOO_SERVERS: server.1=zookeeper-1:2888:3888;2181 server.2=zookeeper-2:2888:3888;2181 server.3=zookeeper-3:2888:3888;2181 server.4=zookeeper-4:2888:3888:observer;2181
      ZOO_4LW_COMMANDS_WHITELIST: "*"
    networks:
      - ansible-net
      - zk-net

  zookeeper-proxy:
    image: haproxy:latest
    container_name: zookeeper-proxy
    profiles:
      - zookeeper
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    depends_on:
      - zookeeper-1
      - zookeeper-2
      - zookeeper-3
      - zookeeper-4
    networks:
      - ansible-net
      - zk-net

networks:
  ansible-net:
    driver: bridge
  zk-net:
    driver: bridge
