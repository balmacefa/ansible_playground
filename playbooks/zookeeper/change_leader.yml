---
- name: Safely Change Zookeeper Leader
  hosts: zookeeper
  connection: local
  gather_facts: false
  tasks:
    - name: Get Zookeeper status and role
      include_tasks: tasks/zookeeper_status.yml

    - name: Identify leader node
      set_fact:
        is_leader: "{{ zookeeper_role == 'leader' }}"
        
    - name: Display current roles
      debug:
        msg: "{{ inventory_hostname }} is {{ 'LEADER' if is_leader else 'FOLLOWER/OBSERVER' }}"

    - name: Restart the leader to force an election
      shell: "docker restart {{ inventory_hostname }}"
      when: is_leader
      register: restart_result
      changed_when: true

    - name: Wait for Zookeeper cluster to stabilize
      pause:
        seconds: 10
      when: is_leader

    - name: Verify new leader election (Wait for recovery)
      include_tasks: tasks/zookeeper_status.yml

    - name: Show the new Leader
      debug:
        msg: "⭐⭐⭐ The NEW Zookeeper Leader is: {{ inventory_hostname }} ⭐⭐⭐"
      when: zookeeper_role == 'leader'
