---
- name: Wait for PostgreSQL database to become available
  ansible.builtin.wait_for:
    host: "{{ inventory_hostname }}"
    port: 5432
    state: started
    timeout: 30

- name: Ensure an application database user exists
  community.postgresql.postgresql_user:
    db: "appdb{{ inventory_hostname | regex_replace('^db-', '') }}"
    name: "user_{{ inventory_hostname | regex_replace('-', '_') }}"
    password: "secure_pass_123"
    login_host: "{{ inventory_hostname }}"
    login_user: admin
    login_password: secretpassword
    state: present

- name: Create a test table for testing
  community.postgresql.postgresql_query:
    db: "appdb{{ inventory_hostname | regex_replace('^db-', '') }}"
    login_host: "{{ inventory_hostname }}"
    login_user: admin
    login_password: secretpassword
    query: |
      CREATE TABLE IF NOT EXISTS test_data (
        id SERIAL PRIMARY KEY,
        node_name VARCHAR(50) NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      );

- name: Insert some test data into the table
  community.postgresql.postgresql_query:
    db: "appdb{{ inventory_hostname | regex_replace('^db-', '') }}"
    login_host: "{{ inventory_hostname }}"
    login_user: admin
    login_password: secretpassword
    query: "INSERT INTO test_data (node_name) VALUES ('Initialized by Ansible on {{ inventory_hostname }}')"
