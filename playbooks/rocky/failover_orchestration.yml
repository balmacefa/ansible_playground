- import_playbook: ../zookeeper/get_leader.yml

- name: Zookeeper Leader Failover POC
  hosts: localhost
  connection: local
  vars:
    current_leader: "{{ hostvars['localhost']['zookeeper_leader'] }}"
  tasks:
    - name: Ensure POC script is deployed to first node
      command: "ansible-playbook -i /playbooks/inventory.ini -l {{ groups['nodes'][0] }} /playbooks/rocky/zookeeper_poc.yml"
      register: deploy_out

    - name: Deploy failover script to first node
      command: "scp /playbooks/rocky/failover_poc_script.py {{ groups['nodes'][0] }}:/tmp/failover_poc.py"

    - name: Ensure script is executable
      command: "docker exec {{ groups['nodes'][0] }} chmod +x /tmp/failover_poc.py"

    - name: Fail if no leader found
      fail:
        msg: "No Zookeeper leader found! Ensure the cluster is healthy."
      when: current_leader == "" or current_leader is not defined

    - name: Display current leader
      debug:
        msg: "Current Zookeeper Leader is: {{ current_leader }}"

    - name: Start Failover POC Script on first node (Async)
      shell: "docker exec {{ groups['nodes'][0] }} bash -c 'python3 /tmp/failover_poc.py > /tmp/failover_poc.log 2>&1 &'"
      async: 60
      poll: 0
      register: script_async

    - name: Wait for script to start (5 seconds)
      pause:
        seconds: 5

    - name: ðŸ’¥ CRASH THE LEADER ðŸ’¥
      command: "docker stop {{ current_leader }}"
      register: stop_out

    - name: Wait for Zookeeper recovery (15 seconds)
      pause:
        seconds: 15

    - name: Collect POC logs from first node
      command: "docker exec {{ groups['nodes'][0] }} cat /tmp/failover_poc.log"
      register: poc_logs

    - name: Display POC Interaction Logs
      debug:
        var: poc_logs.stdout_lines

    - name: ðŸ› ï¸ RECOVER THE CLUSTER ðŸ› ï¸
      command: "docker start {{ current_leader }}"
      
    - name: Final Health Check
      shell: |
        {% for host in groups['zookeeper'] %}
        docker exec {{ host }} bash -c "echo stat | nc localhost {{ zookeeper_client_port | default(2181) }} | grep Mode" || echo "{{ host }} is DOWN"
        {% endfor %}
        # Verify proxy is routing correctly
        if python3 -c 'import socket, sys; s=socket.create_connection(("{{ zookeeper_proxy_name | default("zookeeper-proxy") }}", {{ zookeeper_client_port | default(2181) }}), timeout=2); s.sendall(b"stat"); print(s.recv(1024).decode())' 2>/dev/null | grep 'Mode' > /dev/null; then
          echo "{{ zookeeper_proxy_name | default("zookeeper-proxy") }}: UP (routing to healthy node)"
        else
          echo "{{ zookeeper_proxy_name | default("zookeeper-proxy") }}: DOWN or NO HEALTHY BACKENDS"
        fi
      register: final_status

    - name: Show Final Cluster Status
      debug:
        var: final_status.stdout_lines
